---
feature: "TUI Todo App"
spec: "./spec.md"
status: "approved"
---

# Technical Plan: TUI Todo App

## Architecture Overview

A standalone example application in `examples/tui-todo/` that demonstrates the supertag-cli codegen feature. The app uses Ink (React for terminals) with a layered architecture: UI components → state management → services → data sources.

```
┌─────────────────────────────────────────────────────────────┐
│                     TUI Layer (Ink/React)                   │
│  ┌─────────────────┐  ┌───────────────────────────────────┐ │
│  │   TodoList      │  │   TodoDetail / CreateForm         │ │
│  │   (left pane)   │  │   (right pane)                    │ │
│  └─────────────────┘  └───────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │   StatusBar (shortcuts) + FilterInput (search)          │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                   State Management (React)                   │
│          useReducer + Context for app state                  │
├─────────────────────────────────────────────────────────────┤
│                      Service Layer                           │
│  ┌─────────────────┐  ┌───────────────────────────────────┐ │
│  │  TodoService    │  │   TanaInputApi                    │ │
│  │  (read from DB) │  │   (create via API)                │ │
│  └─────────────────┘  └───────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                   Generated Effect Schema                    │
│            Todo class from `supertag codegen`                │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌───────────────────────────────────┐ │
│  │ supertag-cli DB │  │   Tana Input API                  │ │
│  │ (SQLite)        │  │   (HTTPS)                         │ │
│  └─────────────────┘  └───────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## Technology Stack

| Component | Choice | Rationale |
|-----------|--------|-----------|
| Language | TypeScript | PAI standard, type safety |
| Runtime | Bun | PAI standard, fast startup |
| TUI Framework | Ink 5.x | React-based, modern, good DX |
| Schema | Effect Schema | Generated by supertag codegen |
| Database | bun:sqlite | Direct access to supertag-cli DB |
| HTTP Client | fetch | Built-in, no dependencies |
| Testing | bun:test | PAI standard |

## Constitutional Compliance

- [x] **CLI-First:** App runs via `bun run examples/tui-todo` or compiled binary
- [x] **Library-First:** Services (TodoService, TanaInputApi) are reusable modules separate from UI
- [x] **Test-First:** TDD for services; UI tested via component snapshots
- [x] **Deterministic:** No AI/LLM calls; pure data fetching and display
- [x] **Code Before Prompts:** All logic in TypeScript; no prompt engineering

## Data Model

### Entities

```typescript
// Generated by: supertag codegen generate -o ./src/schemas.ts --tags Todo
import { Schema } from "effect";

export class Todo extends Schema.Class<Todo>("Todo")({
  id: Schema.String,
  title: Schema.optionalWith(Schema.String, { as: "Option" }),
  dueDate: Schema.optionalWith(Schema.DateFromString, { as: "Option" }),
  completed: Schema.optionalWith(Schema.Boolean, { as: "Option" }),
  status: Schema.optionalWith(Schema.String, { as: "Option" }),
  priority: Schema.optionalWith(Schema.String, { as: "Option" }),
}) {}

// App state (not generated)
interface AppState {
  todos: Todo[];
  selectedIndex: number;
  mode: "list" | "detail" | "create" | "help";
  filter: string;
  loading: boolean;
  error: string | null;
}
```

### Database Query

Read todos from supertag-cli's indexed database:

```sql
SELECT
  n.id,
  n.name as title,
  -- Field values from tuple children
  (SELECT value FROM field_values WHERE node_id = n.id AND field_name = 'Due Date') as dueDate,
  (SELECT value FROM field_values WHERE node_id = n.id AND field_name = 'Completed') as completed,
  (SELECT value FROM field_values WHERE node_id = n.id AND field_name = 'Status') as status,
  (SELECT value FROM field_values WHERE node_id = n.id AND field_name = 'Priority') as priority
FROM nodes n
JOIN tag_applications ta ON n.id = ta.node_id
JOIN supertag_metadata sm ON ta.tag_id = sm.tag_id
WHERE sm.tag_name = 'Todo'
ORDER BY n.created_at DESC;
```

## API Contracts

### Internal APIs

```typescript
// TodoService - reads from supertag-cli database
class TodoService {
  constructor(dbPath: string);

  // Fetch all todos, optionally filtered
  getTodos(filter?: string): Promise<Todo[]>;

  // Get single todo by ID
  getTodoById(id: string): Promise<Todo | null>;
}

// TanaInputApi - creates todos via Tana Input API
class TanaInputApi {
  constructor(apiToken: string);

  // Create a new todo in INBOX
  createTodo(todo: TodoInput): Promise<{ nodeId: string }>;
}

// Input type for creating todos (subset of Todo)
interface TodoInput {
  title: string;
  dueDate?: string;
  priority?: string;
}
```

### External APIs

**Tana Input API** (existing):
```
POST https://europe-west1-tagr-prod.cloudfunctions.net/addToNodeV2
Headers: Authorization: Bearer $TANA_API_TOKEN
Body: {
  "targetNodeId": "INBOX",
  "nodes": [{
    "name": "Todo title",
    "supertags": [{ "id": "<todo-supertag-id>" }],
    "children": [
      { "type": "field", "attributeId": "<field-id>", "children": [{ "name": "value" }] }
    ]
  }]
}
```

## Implementation Strategy

### Phase 1: Foundation (T-1.x)

Set up project structure and core services.

- [ ] T-1.1: Create `examples/tui-todo/` with package.json, tsconfig
- [ ] T-1.2: Generate Todo schema using `supertag codegen`
- [ ] T-1.3: Implement TodoService (read from database)
- [ ] T-1.4: Implement TanaInputApi (create via API)
- [ ] T-1.5: Write tests for services

### Phase 2: Core UI (T-2.x)

Build the terminal user interface.

- [ ] T-2.1: Create App component with state management
- [ ] T-2.2: Implement TodoList component (left pane)
- [ ] T-2.3: Implement TodoDetail component (right pane)
- [ ] T-2.4: Implement CreateForm component with validation
- [ ] T-2.5: Implement StatusBar and keyboard handling
- [ ] T-2.6: Add filter/search functionality

### Phase 3: Integration (T-3.x)

Polish and documentation.

- [ ] T-3.1: Implement HelpOverlay component
- [ ] T-3.2: Add error handling and loading states
- [ ] T-3.3: Write README with usage instructions
- [ ] T-3.4: Add to supertag-cli documentation

## File Structure

```
examples/
└── tui-todo/
    ├── package.json              # [New] Ink, Effect deps
    ├── tsconfig.json             # [New] TS config
    ├── README.md                 # [New] Usage docs
    ├── src/
    │   ├── index.tsx             # [New] Entry point
    │   ├── schemas.ts            # [New] Generated by codegen
    │   ├── components/
    │   │   ├── App.tsx           # [New] Main app + state
    │   │   ├── TodoList.tsx      # [New] Left pane
    │   │   ├── TodoDetail.tsx    # [New] Right pane
    │   │   ├── CreateForm.tsx    # [New] Creation form
    │   │   ├── HelpOverlay.tsx   # [New] Help display
    │   │   └── StatusBar.tsx     # [New] Bottom bar
    │   ├── services/
    │   │   ├── todo-service.ts   # [New] DB access
    │   │   └── tana-api.ts       # [New] Input API
    │   ├── hooks/
    │   │   └── useApp.ts         # [New] App state hook
    │   └── types/
    │       └── app-state.ts      # [New] State types
    └── tests/
        ├── todo-service.test.ts  # [New] Service tests
        └── tana-api.test.ts      # [New] API tests

README.md                         # [Modified] Add example reference
```

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Ink complexity | Med | Med | Use simple components; reference ink examples |
| Terminal compatibility | Med | Low | Test in iTerm2, Terminal.app, VS Code |
| No Todo supertag | High | Med | Provide sample schema; document setup steps |
| Database schema changes | Med | Low | Use stable supertag-cli queries |
| API rate limits | Low | Low | Single user; minimal API calls |

## Dependencies

### External (new for example app)

| Package | Version | Purpose |
|---------|---------|---------|
| ink | ^5.0.1 | React-based terminal UI |
| react | ^18.2.0 | Required by Ink |
| ink-text-input | ^6.0.0 | Text input component |
| effect | ^3.0.0 | Schema validation |

### Internal (from supertag-cli)

- `bun:sqlite` - Database access
- Generated schema from `supertag codegen`
- Database path resolution from supertag-cli conventions

## Migration/Deployment

- [ ] **Database migrations:** None - reads existing supertag-cli DB
- [ ] **Environment variables:** `TANA_API_TOKEN` (existing requirement)
- [ ] **Breaking changes:** None - standalone example app
- [ ] **Build:** Can be compiled to standalone binary with `bun build`

## Estimated Complexity

- **New files:** ~15
- **Modified files:** 1 (README.md)
- **Test files:** 2
- **Estimated tasks:** ~14 (T-1.1 through T-3.4)
- **Effort:** Medium (2-3 sessions)
